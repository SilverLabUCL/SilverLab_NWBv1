classdef (SharedTestFixtures=SharedFixtures()) ...
        TestReadNwb < matlab.unittest.TestCase
    %TESTREADNWB Tests of reading NWB files
    
    properties
    end
    
    methods (Test)
        function testReadEpochData(testCase)
            %TESTREADEPOCHDATA Check we can read the test_epochs output
            
            nwb = NwbFile('data/test_epochs.nwb');
            testCase.verifyEqual(nwb.get('/silverlab_api_version'), '0.1');
            testCase.verifyEqual(nwb.get('/session_description'), ...
                'Test epoch calculation');
            expected_speeds = single([...
                0.0, 0.0, 0.0, -2.79, -2.79, 0.0, -2.79, -2.79, -2.79, ...
                0.0, 0.0, -2.8, 0.0, ...
                0.0, -2.79, 0.0, ...
                0.0, 0.0, -2.8, 0.0, 0.0, 0.0, 0.0, ...
                0.0, 0.0, 0.0]);
            testCase.verifyEqual(...
                nwb.get('/acquisition/timeseries/speed_data/data'), ...
                expected_speeds, 'AbsTol', 0.001);
            testCase.verifyEqual(...
                nwb.get('/epochs/trial_0002/start_time'), ...
                14.104865, 'AbsTol', 0.000001);
            testCase.verifyEqual(...
                nwb.get('/epochs/trial_0001/stop_time'), ...
                14.097292, 'AbsTol', 0.000001);
            testCase.verifyEqual(...
                nwb.get('/epochs/trial_0001/speed_data/count'), ...
                int32(13));
            testCase.verifyEqual(...
                nwb.get('/epochs/trial_0002/speed_data/idx_start'), ...
                int32(16));

            % Format string usage
            testCase.verifyEqual(...
                nwb.get('/epochs/trial_%04d/speed_data/idx_start', 2), ...
                int32(16));
            testCase.verifyEqual(...
                nwb.get('/epochs/trial_%04d/speed_data/%s', 2, 'idx_start'), ...
                int32(16));

            % Extracting one trial's data
            testCase.verifyEqual(...
                nwb.get_trial_data(1, 'speed_data'), ...
                expected_speeds(1:13).', 'AbsTol', 0.001);
            expected_times = [...
                0.000966, 0.003109, 0.005253, 0.365729, 0.367876, 0.370024, 0.372169, 0.374316, 0.376464, 0.378611, 14.093001, 14.095145, 14.097292, ...
                14.098427, 14.102718, 14.104865, ...
                14.105296, 14.107440, 14.109584, 14.111731, 14.113876, 28.200175, 28.202320, ...
                28.203617, 28.207918, 28.210062];
            testCase.verifyEqual(...
                nwb.get_trial_data('trial_0002', 'speed_data', 'timestamps'), ...
                expected_times(17:23).', 'AbsTol', 0.001);

            % Extracting multiple trials' data
            testCase.verifyEqual(...
                nwb.get_trials_data('speed_data'), ...
                {expected_speeds(1:13).', expected_speeds(17:23).'}, ...
                'AbsTol', 0.001);
            testCase.verifyEqual(...
                nwb.get_trials_data('speed_data', 'timestamps', [2]), ...
                {expected_times(17:23).'}, ...
                'AbsTol', 0.001);

            % Test our helper methods/properties too
            testCase.verifyTrue(...
                endsWith(nwb.path, 'data/test_epochs.nwb'));
            testCase.verifyEqual(nwb.num_trials, 2);

            testCase.verifyError(@() nwb.num_rois, 'NwbFile:rois:missing');
            testCase.verifyError(@() nwb.num_cycles_per_trial, ...
                'NwbFile:imaging:missing');
            testCase.verifyError(@() nwb.cycle_time, ...
                'MATLAB:imagesci:hdf5lib:libraryError');
        end
    end
end

